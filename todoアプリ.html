<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ToDoã‚¢ãƒ—ãƒª</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
</head>
<body>

<div class="modal fade" id="myModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ã‚µãƒ–ã‚¿ã‚¹ã‚¯å…¥åŠ›</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="subtask" class="form-control" placeholder="ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="button" id="modal-ok" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>
</div>

  <div class="h1 container">ToDoã‚¢ãƒ—ãƒª ver1.04ğŸ“</div>

  <div class="h2 container" id="date-display"></div>
  <div class="container" id="ww_015ccc60f42be" v='1.3' loc='id' a='{"t":"responsive","lang":"ja","sl_lpl":1,"ids":["wl926"],"font":"Arial","sl_ics":"one_a","sl_sot":"celsius","cl_bkg":"image","cl_font":"#FFFFFF","cl_cloud":"#FFFFFF","cl_persp":"#81D4FA","cl_sun":"#FFC107","cl_moon":"#FFC107","cl_thund":"#FF5722"}'>More forecasts: <a href="https://oneweather.org/ja/tokyo/10_days/" id="ww_015ccc60f42be_u" target="_blank">æ±äº¬ 10æ—¥é–“å¤©æ°—</a></div><script async src="https://app3.weatherwidget.org/js/?id=ww_015ccc60f42be"></script>
  
  <div class="container border gap-3 shadow p-3 my-3">
    <div class="d-flex flex-column gap-3 flex-md-row mb-3">
      <input type="text" id="todoInput" class="form-control" placeholder="ã‚„ã‚‹ã“ã¨ã‚’å…¥åŠ›">
      <button type="button" class="btn btn-primary col-12 col-md-auto" onclick="addTodo()">è¿½åŠ </button>
      <button class="btn btn-secondary col-12 col-md-auto" onclick="saveAsXML()">XMLä¿å­˜</button>
    </div>
    <div class=""><input class="form-control" type="file" accept=".xml" onchange="loadFromXML(event)"></div>
  </div>

  <div class="container" id="todoList">
  </div>

  <script>
// ã‚¤ãƒ™ãƒ³ãƒˆ
   window.onload = () => {
     setDate();
     loadFromLocalStorage();
   };

   window.onunload = () => {
     saveToLocalStorage();
   };


// æ—¥ä»˜ã®ã‚»ãƒƒãƒˆ
    function setDate() {
       const dateLable = document.getElementById("date-display");
       
       const date = new Date();
       const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
       const formattedDate = `${date.getFullYear()}å¹´ ${date.getMonth() + 1}æœˆ ${date.getDate()}æ—¥ ${weekdays[date.getDay()]}æ›œæ—¥`;
       dateLable.textContent = formattedDate;
    }

// ã‚¿ã‚¹ã‚¯è¿½åŠ 
    function addTodo(text = "", checked = false, priority = "â„¹ï¸ä½", subtasks = []) {

      // ã‚¿ã‚¹ã‚¯å…¨ä½“ã‚’ãƒ©ãƒƒãƒ—
      const container = document.createElement("div");
      container.className = "d-flex flex-column mb-3";

      // å…¥åŠ›ã®å—ã‘å–ã‚Š
      const input = document.getElementById("todoInput");
      if (text === "") {
        text = input.value.trim();
        if (text === "") return;
      }

      // é …ç›®ã®è¿½åŠ 
      const item = document.createElement("label");
      item.className = "d-flex flex-row gap-3 flex-wrap border p-3";

      //ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ã‚’è¿½åŠ 
       let draggedItem = null;
       
      item.draggable = true;
      item.ondragstart = (e) => {
        e.dataTransfer.setData("text/plain", null);
        draggedItem = item;
      };
      
      item.ondragover = (e) => {
        e.preventDefault();
      };
      
      item.ondrop = (e) => {
        e.preventDefault();
        const todoList = document.getElementById("todoList");
        if (draggedItem !== item) {
          todoList.insertBefore(draggedItem, item.nextSibling);
          saveToLocalStorage(); // ä¸¦ã³æ›¿ãˆå¾Œã«ä¿å­˜
        }
      };

      // ã‚¿ã‚¹ã‚¯å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.className = "form-check-input";
      checkbox.checked = checked;
      checkbox.onchange = () => {
        item.classList.toggle("bg-success", checkbox.checked);
      };
      // èµ·å‹•æ™‚ã€æ—¢ã«ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã®æ™‚
      if (checked) item.classList.add("bg-success");
      // ãƒ©ãƒƒãƒ—
      const checkboxCol = document.createElement("div");
      checkboxCol.className = "col-auto p-2";
      checkboxCol.appendChild(checkbox);

      // ã‚¿ã‚¹ã‚¯
      const task = document.createElement("input");
      task.type = "text";
      task.className = "form-control";
      task.value = text;
      // ãƒ©ãƒƒãƒ—
      const taskCol = document.createElement("div");
      taskCol.className = "col-12 col-md-5 col-lg-6";
      taskCol.appendChild(task);

      // é‡è¦åº¦ã‚»ãƒ¬ã‚¯ãƒˆ
      const select = document.createElement('select');
      select.className = "form-select";
      select.ariaLabel = "Default select";
      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®è¿½åŠ 
      const items = ["ğŸ’¥é«˜", "âš ï¸ä¸­", "â„¹ï¸ä½"];
      items.forEach(text => {
        const option = document.createElement('option');
        option.textContent = text;
        option.value = text;
        select.appendChild(option);
      });
      
      // ãƒœã‚¿ãƒ³è¦ç´ ã®ä½œæˆ
      /*
      const button = document.createElement('button');
      button.className = 'btn btn-secondary dropdown-toggle';
      button.type = 'button';
      button.id = 'dropdownMenuButton';
      button.setAttribute('data-bs-toggle', 'dropdown');
      button.setAttribute('aria-expanded', 'false');
      button.textContent = 'å„ªå…ˆåº¦';

      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ä½œæˆ
      const menu = document.createElement('ul');
      menu.className = 'dropdown-menu';
      menu.setAttribute('aria-labelledby', 'dropdownMenuButton');

      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®è¿½åŠ 
      const items = ["ğŸ’¥é«˜", "âš ï¸ä¸­", "â„¹ï¸ä½"];
      items.forEach(text => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.className = 'dropdown-item';
        a.href = '#';
        a.textContent = text;
        li.appendChild(a);
        menu.appendChild(li);
      });
      */
      // ãƒ©ãƒƒãƒ—
      const priorityCol = document.createElement('div');
      priorityCol.className = "col-auto";
      priorityCol.appendChild(select);

      // ã‚µãƒ–ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒœã‚¿ãƒ³
      const subBtn = document.createElement("button");
      subBtn.textContent = "ï¼‹ã‚µãƒ–ã‚¿ã‚¹ã‚¯";
      subBtn.className = "form-control btn btn-secondary";
      subBtn.onclick = () => {
        // å…¥åŠ›ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
        const modal = new bootstrap.Modal(document.getElementById('myModal'));
        modal.show();

        const okButton = document.getElementById('modal-ok');
        const subInput = document.getElementById('subtask');
        subInput.value = "";
        okButton.onclick = () => {
          const subText = subInput.value.trim();
          if (subText) {
            const subLi = createSubtaskElement(subText, false);
            subtaskList.appendChild(subLi);
            modal.hide();
          }
        };
      };
      // ãƒ©ãƒƒãƒ—
      const subBtnCol = document.createElement("div");
      subBtnCol.className = "col-12 col-md-auto";
      subBtnCol.appendChild(subBtn);

      // å‰Šé™¤ãƒœã‚¿ãƒ³
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "å‰Šé™¤";
      deleteBtn.className = "form-control btn btn-danger";
      deleteBtn.onclick = () => item.remove();
      // ãƒ©ãƒƒãƒ—
      const deleteBtnCol = document.createElement("div");
      deleteBtnCol.className = "col-12 col-md-auto ms-auto";
      deleteBtnCol.appendChild(deleteBtn);

      // ã‚µãƒ–ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ
      const subtaskList = document.createElement("div");
      subtaskList.className = "ps-3";
      // æ—¢å­˜ã®ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã‚’å¾©å…ƒ
      subtasks.forEach(sub => {
        const subLi = createSubtaskElement(sub.text, sub.completed);
        subtaskList.appendChild(subLi);
      });

      // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¿½åŠ 
      item.appendChild(checkboxCol);
      item.appendChild(priorityCol);
      item.appendChild(taskCol);
      item.appendChild(subBtnCol);
      item.appendChild(deleteBtnCol);
      container.appendChild(item);
      container.appendChild(subtaskList);

      document.getElementById("todoList").appendChild(container);
      input.value = "";
    }

// ã‚µãƒ–ã‚¿ã‚¹ã‚¯è¿½åŠ 
    function createSubtaskElement(text, completed) {
      const subLi = document.createElement("label");
      subLi.className = 'd-flex flex-row border gap-3 p-3';
      subLi.id = "subtask-list";

      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
      const subCheckbox = document.createElement("input");
      subCheckbox.type = "checkbox";
      subCheckbox.className = "form-check-input"
      subCheckbox.checked = completed;
      subCheckbox.onchange = () => {
        subLi.classList.toggle("bg-success", subCheckbox.checked);
      };
      // èµ·å‹•æ™‚ã€æ—¢ã«ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã®æ™‚
      if (completed) subLi.classList.add("bg-success");
      // ãƒ©ãƒƒãƒ—
      const subCheckCol = document.createElement("div");
      subCheckCol.className = "p-2";
      subCheckCol.appendChild(subCheckbox);

      // ã‚µãƒ–ã‚¿ã‚¹ã‚¯
      const subTask = document.createElement("input");
      subTask.type = "text";
      subTask.value = text;
      subTask.className = "form-control";
      if (completed) subLi.classList.add("completed");
      // ãƒ©ãƒƒãƒ—
      const subTaskCol = document.createElement("div");
      subTaskCol.className = "col";
      subTaskCol.appendChild(subTask);

      // å‰Šé™¤ãƒœã‚¿ãƒ³
      const subDeleteBtn = document.createElement("button");
      subDeleteBtn.textContent = "å‰Šé™¤";
      subDeleteBtn.className = "form-control btn btn-danger";
      subDeleteBtn.onclick = () => subLi.remove();
      // ãƒ©ãƒƒãƒ—
      const subDeleteBtnCol = document.createElement("div");
      subDeleteBtnCol.className = "ms-auto";
      subDeleteBtnCol.appendChild(subDeleteBtn);

      subLi.appendChild(subCheckCol);
      subLi.appendChild(subTaskCol);
      subLi.appendChild(subDeleteBtnCol);

      return subLi;
    }

// XMLä¿å­˜
    function saveAsXML() {
      const todos = document.querySelectorAll("#todoList");
      let xml = '<?xml version="1.0" encoding="UTF-8"?>\n<todos>\n';
      todos.forEach(task => {
        const text = task.querySelector("input[type='text']").value;
        const completed = task.querySelector("input[type='checkbox']").checked;
        const priority = task.querySelector("select").value;
        xml += `  <todo completed="${completed}" priority="${priority}">${text}\n`;
        const subtasks = task.querySelectorAll("#subtask-list");
        subtasks.forEach(subtask => {
          const subText = subtask.querySelector("input[type='text']").value;
          const subCompleted = subtask.querySelector("input[type='checkbox']").checked;
          xml += `    <subtask completed="${subCompleted}">${subText}</subtask>\n`;
        });
        xml += `  </todo>\n`;
      });
      xml += '</todos>';

      const blob = new Blob([xml], { type: "application/xml" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "todos.xml";
      a.click();
    }

// XMLèª­ã¿è¾¼ã¿
    function loadFromXML(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(e.target.result, "application/xml");
        const todoElements = xmlDoc.getElementsByTagName("todo");

        document.getElementById("todoList").innerHTML = "";
        for (let todo of todoElements) {
          const text = todo.textContent.trim().split("\n")[0].trim(); // ã‚¿ã‚¹ã‚¯ã®æœ¬æ–‡
          const completed = todo.getAttribute("completed") === "true";
          const priority = todo.getAttribute("priority") || "â„¹ï¸ä½";

          const subtaskNodes = todo.getElementsByTagName("subtask");
          const subtasks = Array.from(subtaskNodes).map(sub => ({
            text: sub.textContent,
            completed: sub.getAttribute("completed") === "true"
          }));

          addTodo(text, completed, priority, subtasks);
        }
      };
      reader.readAsText(file);
    }

// localstrageä¿å­˜
    function saveToLocalStorage() {
      const todos = [];
      document.querySelectorAll("#todoList").forEach(task => {
        const text = task.querySelector("input[type='text']").value;
        const completed = task.querySelector("input[type='checkbox']").checked;
        const priority = task.querySelector("select").value;
    
        const subtasks = Array.from(task.querySelectorAll("#subtask-list")).map(subtask => {
          return {
            text: subtask.querySelector("input[type='text']").value,
            completed: subtask.querySelector("input[type='checkbox']").checked
          };
        });
    
        todos.push({ text, completed, priority, subtasks });
      });
    
      localStorage.setItem("todoData", JSON.stringify(todos));
    }
    
// localstrageèª­ã¿è¾¼ã¿
    function loadFromLocalStorage() {
      const data = JSON.parse(localStorage.getItem("todoData") || "[]");
      document.getElementById("todoList").innerHTML = "";
      data.forEach(item => {
        addTodo(item.text, item.completed, item.priority, item.subtasks);
      });
    }

  </script>
</body>
</html>