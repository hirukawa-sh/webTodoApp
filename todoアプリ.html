<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ToDo„Ç¢„Éó„É™</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
</head>
<body>
  <div class="h1 container">ToDo„Ç¢„Éó„É™ ver1.04üìù</div>

  <div class="h2 container" id="date-display"></div>
  <div class="container" id="ww_015ccc60f42be" v='1.3' loc='id' a='{"t":"responsive","lang":"ja","sl_lpl":1,"ids":["wl926"],"font":"Arial","sl_ics":"one_a","sl_sot":"celsius","cl_bkg":"image","cl_font":"#FFFFFF","cl_cloud":"#FFFFFF","cl_persp":"#81D4FA","cl_sun":"#FFC107","cl_moon":"#FFC107","cl_thund":"#FF5722"}'>More forecasts: <a href="https://oneweather.org/ja/tokyo/10_days/" id="ww_015ccc60f42be_u" target="_blank">Êù±‰∫¨ 10Êó•ÈñìÂ§©Ê∞ó</a></div><script async src="https://app3.weatherwidget.org/js/?id=ww_015ccc60f42be"></script>
  
  <div class="container border px-3 py-3">
    <div class="d-flex flex-column flex-md-row">
      <input type="text" id="todoInput" class="form-control mb-3" placeholder="„ÇÑ„Çã„Åì„Å®„ÇíÂÖ•Âäõ">
      <button type="button" class="btn btn-primary col-12 col-md-auto mb-3" onclick="addTodo()">ËøΩÂä†</button>
      <button class="btn btn-secondary col-12 col-md-auto mb-3" onclick="saveAsXML()">XML‰øùÂ≠ò</button>
    </div>
    <div class="mb-3"><input class="form-control" type="file" accept=".xml" onchange="loadFromXML(event)"></div>
  </div>

  <div class="container py-3" id="todoList">
  </div>

  <script>
// „Ç§„Éô„É≥„Éà
   window.onload = () => {
     setDate();
     loadFromLocalStorage();
   };

   window.onunload = () => {
     saveToLocalStorage();
   };


// Êó•‰ªò„ÅÆ„Çª„ÉÉ„Éà
    function setDate() {
       const dateLable = document.getElementById("date-display");
       
       const date = new Date();
       const weekdays = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
       const formattedDate = `${date.getFullYear()}Âπ¥ ${date.getMonth() + 1}Êúà ${date.getDate()}Êó• ${weekdays[date.getDay()]}ÊõúÊó•`;
       dateLable.textContent = formattedDate;
    }

// „Çø„Çπ„ÇØËøΩÂä†
    function addTodo(text = "", checked = false, priority = "‚ÑπÔ∏è‰Ωé", subtasks = []) {

      // „Çø„Çπ„ÇØÂÖ®‰Ωì„Çí„É©„ÉÉ„Éó
      const container = document.createElement("div");
      container.className = "d-flex flex-column";

      // ÂÖ•Âäõ„ÅÆÂèó„ÅëÂèñ„Çä
      const input = document.getElementById("todoInput");
      if (text === "") {
        text = input.value.trim();
        if (text === "") return;
      }

      // È†ÖÁõÆ„ÅÆËøΩÂä†
      const item = document.createElement("label");
      item.className = "d-flex flex-row flex-wrap border py-3";

      //„Éâ„É©„ÉÉ„Ç∞Ê©üËÉΩ„ÇíËøΩÂä†
       let draggedItem = null;
       
      item.draggable = true;
      item.ondragstart = (e) => {
        e.dataTransfer.setData("text/plain", null);
        draggedItem = item;
      };
      
      item.ondragover = (e) => {
        e.preventDefault();
      };
      
      item.ondrop = (e) => {
        e.preventDefault();
        const todoList = document.getElementById("todoList");
        if (draggedItem !== item) {
          todoList.insertBefore(draggedItem, item.nextSibling);
          saveToLocalStorage(); // ‰∏¶„Å≥Êõø„ÅàÂæå„Å´‰øùÂ≠ò
        }
      };

      // „Çø„Çπ„ÇØÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.className = "form-check-input";
      checkbox.checked = checked;
      checkbox.onchange = () => {
        item.classList.toggle("bg-success", checkbox.checked);
      };
      // Ëµ∑ÂãïÊôÇ„ÄÅÊó¢„Å´„ÉÅ„Çß„ÉÉ„ÇØÊ∏à„Åø„ÅÆÊôÇ
      if (checked) item.classList.add("bg-success");
      // „É©„ÉÉ„Éó
      const checkboxCol = document.createElement("div");
      checkboxCol.className = "col-auto p-2";
      checkboxCol.appendChild(checkbox);

      // „Çø„Çπ„ÇØ
      const task = document.createElement("input");
      task.type = "text";
      task.className = "form-control";
      task.value = text;
      // „É©„ÉÉ„Éó
      const taskCol = document.createElement("div");
      taskCol.className = "col-md-auto col-7";
      taskCol.appendChild(task);

      // ÈáçË¶ÅÂ∫¶„Çª„É¨„ÇØ„Éà
      const select = document.createElement('select');
      select.className = "form-select";
      select.ariaLabel = "Default select";
      // „É°„Éã„É•„ÉºÈ†ÖÁõÆ„ÅÆËøΩÂä†
      const items = ["üí•È´ò", "‚ö†Ô∏è‰∏≠", "‚ÑπÔ∏è‰Ωé"];
      items.forEach(text => {
        const option = document.createElement('option');
        option.textContent = text;
        option.value = text;
        select.appendChild(option);
      });
      
      // „Éú„Çø„É≥Ë¶ÅÁ¥†„ÅÆ‰ΩúÊàê
      /*
      const button = document.createElement('button');
      button.className = 'btn btn-secondary dropdown-toggle';
      button.type = 'button';
      button.id = 'dropdownMenuButton';
      button.setAttribute('data-bs-toggle', 'dropdown');
      button.setAttribute('aria-expanded', 'false');
      button.textContent = 'ÂÑ™ÂÖàÂ∫¶';

      // „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„É°„Éã„É•„Éº„ÅÆ‰ΩúÊàê
      const menu = document.createElement('ul');
      menu.className = 'dropdown-menu';
      menu.setAttribute('aria-labelledby', 'dropdownMenuButton');

      // „É°„Éã„É•„ÉºÈ†ÖÁõÆ„ÅÆËøΩÂä†
      const items = ["üí•È´ò", "‚ö†Ô∏è‰∏≠", "‚ÑπÔ∏è‰Ωé"];
      items.forEach(text => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.className = 'dropdown-item';
        a.href = '#';
        a.textContent = text;
        li.appendChild(a);
        menu.appendChild(li);
      });
      */
      // „É©„ÉÉ„Éó
      const priorityCol = document.createElement('div');
      priorityCol.className = "col-auto";
      priorityCol.appendChild(select);

      // „Çµ„Éñ„Çø„Çπ„ÇØËøΩÂä†„Éú„Çø„É≥
      const subBtn = document.createElement("button");
      subBtn.textContent = "Ôºã„Çµ„Éñ„Çø„Çπ„ÇØ";
      subBtn.className = "form-control";
      subBtn.onclick = () => {
        const subText = prompt("„Çµ„Éñ„Çø„Çπ„ÇØ„ÅÆÂÜÖÂÆπ„ÇíÂÖ•Âäõ");
        if (!subText) return;
        const subLi = createSubtaskElement(subText, false);
        subtaskList.appendChild(subLi);
      };
      // „É©„ÉÉ„Éó
      const subBtnCol = document.createElement("div");
      subBtnCol.className = "col-auto";
      subBtnCol.appendChild(subBtn);

      // ÂâäÈô§„Éú„Çø„É≥
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "ÂâäÈô§";
      deleteBtn.className = "form-control";
      deleteBtn.onclick = () => item.remove();
      // „É©„ÉÉ„Éó
      const deleteBtnCol = document.createElement("div");
      deleteBtnCol.className = "col-auto ms-auto";
      deleteBtnCol.appendChild(deleteBtn);

      // „Çµ„Éñ„Çø„Çπ„ÇØ„É™„Çπ„Éà
      const subtaskList = document.createElement("div");
      subtaskList.className = "";
      // Êó¢Â≠ò„ÅÆ„Çµ„Éñ„Çø„Çπ„ÇØ„ÇíÂæ©ÂÖÉ
      subtasks.forEach(sub => {
        const subLi = createSubtaskElement(sub.text, sub.completed);
        subtaskList.appendChild(subLi);
      });

      // „Ç≥„É≥„Éà„É≠„Éº„É´ËøΩÂä†
      item.appendChild(checkboxCol);
      item.appendChild(priorityCol);
      item.appendChild(taskCol);
      item.appendChild(subBtnCol);
      item.appendChild(deleteBtnCol);
      container.appendChild(item);
      container.appendChild(subtaskList);

      document.getElementById("todoList").appendChild(container);
      input.value = "";
    }

// „Çµ„Éñ„Çø„Çπ„ÇØËøΩÂä†
    function createSubtaskElement(text, completed) {
      const subLi = document.createElement("div");
      subLi.className = 'd-flex flex-row border p-3';

      // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ
      const subCheckbox = document.createElement("input");
      subCheckbox.type = "checkbox";
      subCheckbox.className = "form-checkbox"
      subCheckbox.checked = completed;
      subCheckbox.onchange = () => {
        subLi.classList.toggle("completed", subCheckbox.checked);
      };
      // „É©„ÉÉ„Éó
      const subCheckCol = document.createElement("div");
      subCheckCol.className = "col";
      subCheckCol.appendChild(subCheckbox);

      // „Çµ„Éñ„Çø„Çπ„ÇØ
      const subTask = document.createElement("input");
      subTask.type = "text";
      subTask.value = text;
      subTask.className = "form-control";
      if (completed) subLi.classList.add("completed");
      // „É©„ÉÉ„Éó
      const subTaskCol = document.createElement("div");
      subTaskCol.className = "col";
      subTaskCol.appendChild(subTask);

      // ÂâäÈô§„Éú„Çø„É≥
      const subDeleteBtn = document.createElement("button");
      subDeleteBtn.textContent = "ÂâäÈô§";
      subDeleteBtn.className = "form-control ms-auto";
      subDeleteBtn.onclick = () => subLi.remove();
      // „É©„ÉÉ„Éó
      const subDeleteBtnCol = document.createElement("div");
      subDeleteBtnCol.className = "col";
      subDeleteBtnCol.appendChild(subDeleteBtn);

      subLi.appendChild(subCheckCol);
      subLi.appendChild(subTaskCol);
      subLi.appendChild(subDeleteBtnCol);

      return subLi;
    }

// XML‰øùÂ≠ò
    function saveAsXML() {
      const todos = document.querySelectorAll("#todoList");
      let xml = '<?xml version="1.0" encoding="UTF-8"?>\n<todos>\n';
      todos.forEach(task => {
        const text = task.querySelector("input[type='text']").value;
        const completed = task.querySelector("input[type='checkbox']").checked;
        const priority = task.querySelector("select").value;
        xml += `  <todo completed="${completed}" priority="${priority}">${text}\n`;
        const subtasks = task.querySelectorAll(".subtask-list");
        subtasks.forEach(subtask => {
          const subText = subtask.querySelector("input[type='text']").value;
          const subCompleted = subtask.querySelector("input[type='checkbox']").checked;
          xml += `    <subtask completed="${subCompleted}">${subText}</subtask>\n`;
        });
        xml += `  </todo>\n`;
      });
      xml += '</todos>';

      const blob = new Blob([xml], { type: "application/xml" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "todos.xml";
      a.click();
    }

// XMLË™≠„ÅøËæº„Åø
    function loadFromXML(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(e.target.result, "application/xml");
        const todoElements = xmlDoc.getElementsByTagName("todo");

        document.getElementById("todoList").innerHTML = "";
        for (let todo of todoElements) {
          const text = todo.textContent.trim().split("\n")[0].trim(); // „Çø„Çπ„ÇØ„ÅÆÊú¨Êñá
          const completed = todo.getAttribute("completed") === "true";
          const priority = todo.getAttribute("priority") || "‚ÑπÔ∏è‰Ωé";

          const subtaskNodes = todo.getElementsByTagName("subtask");
          const subtasks = Array.from(subtaskNodes).map(sub => ({
            text: sub.textContent,
            completed: sub.getAttribute("completed") === "true"
          }));

          addTodo(text, completed, priority, subtasks);
        }
      };
      reader.readAsText(file);
    }

// localstrage‰øùÂ≠ò
    function saveToLocalStorage() {
      const todos = [];
      document.querySelectorAll("#todoList").forEach(task => {
        const text = task.querySelector("input[type='text']").value;
        const completed = task.querySelector("input[type='checkbox']").checked;
        const priority = task.querySelector("select").value;
    
        const subtasks = Array.from(task.querySelectorAll(".subtask-list")).map(subtask => {
          return {
            text: subtask.querySelector("input[type='text']").value,
            completed: subtask.querySelector("input[type='checkbox']").checked
          };
        });
    
        todos.push({ text, completed, priority, subtasks });
      });
    
      localStorage.setItem("todoData", JSON.stringify(todos));
    }
    
// localstrageË™≠„ÅøËæº„Åø
    function loadFromLocalStorage() {
      const data = JSON.parse(localStorage.getItem("todoData") || "[]");
      document.getElementById("todoList").innerHTML = "";
      data.forEach(item => {
        addTodo(item.text, item.completed, item.priority, item.subtasks);
      });
    }

  </script>
</body>
</html>